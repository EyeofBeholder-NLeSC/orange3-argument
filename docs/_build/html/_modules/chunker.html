<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>chunker &mdash; Orange3-Argument 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Orange3-Argument
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example.html">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../widget_guis.html">Widget GUIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Orange3-Argument</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">chunker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for chunker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Argument chunker module&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sentence_transformers</span> <span class="kn">import</span> <span class="n">SentenceTransformer</span>
<span class="kn">from</span> <span class="nn">umap</span> <span class="kn">import</span> <span class="n">UMAP</span>
<span class="kn">from</span> <span class="nn">hdbscan</span> <span class="kn">import</span> <span class="n">HDBSCAN</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">bertopic</span> <span class="kn">import</span> <span class="n">BERTopic</span>
<span class="kn">from</span> <span class="nn">bertopic.vectorizers</span> <span class="kn">import</span> <span class="n">ClassTfidfTransformer</span>
<span class="kn">from</span> <span class="nn">bertopic.representation</span> <span class="kn">import</span> <span class="n">PartOfSpeech</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>


<div class="viewcode-block" id="load_nlp_pipe">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.load_nlp_pipe">[docs]</a>
<span class="k">def</span> <span class="nf">load_nlp_pipe</span><span class="p">(</span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the required nlp pipe if not exist</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name (str): name of the nlp pipe, a full list of models can be found from https://spacy.io/usage/models.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The spacy nlp model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">spacy</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spacy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_chunk">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.get_chunk">[docs]</a>
<span class="k">def</span> <span class="nf">get_chunk</span><span class="p">(</span><span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split documents of a given corpus into chunks.</span>

<span class="sd">    A chunk can be considered as a meaningful clause, which can be part of a sentence. For instance, the sentence &quot;I like the color of this car but it&#39;s too expensive.&quot; will be splitted as two chunks, which are &quot;I like the color of this car&quot; and &quot;but it&#39;s too expensive&quot;. A dependency parser is implemented for doing this job.</span>

<span class="sd">    Args:</span>
<span class="sd">        docs (List[str]): The input corpus.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[int]: ids of the arguments that the chunks belongs to.</span>
<span class="sd">        List[str]: chunk text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arg_ids</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">create_chunk</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">arg_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge words into chunk and add to the output lists&quot;&quot;&quot;</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
        <span class="n">arg_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_id</span><span class="p">)</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_heads</span><span class="p">(</span><span class="n">sentence</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify the sentence heads. Currently, the strategy is quite basic: it involves designating as heads all words whose dependencies are conjunctions. However, there is room for enhancement in the future.&quot;&quot;&quot;</span>
        <span class="n">heads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sentence</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">dep_</span> <span class="o">==</span> <span class="s2">&quot;conj&quot;</span><span class="p">:</span>
                <span class="n">heads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">heads</span>

    <span class="n">nlp</span> <span class="o">=</span> <span class="n">load_nlp_pipe</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;en_core_web_md&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">doc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">nlp</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">sents</span><span class="p">:</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">heads</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">spacy</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">span</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_heads</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">heads</span><span class="p">:</span>
                    <span class="n">head_phrase</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">head</span><span class="o">.</span><span class="n">subtree</span><span class="p">)</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">head_phrase</span><span class="p">)</span>
                    <span class="n">create_chunk</span><span class="p">(</span><span class="n">words</span><span class="o">=</span><span class="n">head_phrase</span><span class="p">,</span> <span class="n">arg_id</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">unseen</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">sentence</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">]</span>
                <span class="n">create_chunk</span><span class="p">(</span><span class="n">words</span><span class="o">=</span><span class="n">unseen</span><span class="p">,</span> <span class="n">arg_id</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arg_ids</span><span class="p">,</span> <span class="n">chunks</span></div>



<div class="viewcode-block" id="get_chunk_polarity_score">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.get_chunk_polarity_score">[docs]</a>
<span class="k">def</span> <span class="nf">get_chunk_polarity_score</span><span class="p">(</span><span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute polarity score of each chunk in the given list.</span>

<span class="sd">    The polarity score is a float within the range [-1.0, 1.0], where 0 means neutral, + means positive, and - means negative.</span>

<span class="sd">    Args:</span>
<span class="sd">        chunks (List[str]): chunk list</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[float]: polarity scores of the given chunks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
        <span class="n">p_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TextBlob</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">polarity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_scores</span></div>



<div class="viewcode-block" id="get_chunk_topic">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.get_chunk_topic">[docs]</a>
<span class="k">def</span> <span class="nf">get_chunk_topic</span><span class="p">(</span><span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get topic information and embedding vectors of chunks via topic modeling.</span>

<span class="sd">    Args:</span>
<span class="sd">        chunks (List[str]): chunk list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[int]: topic ids of chunks.</span>
<span class="sd">        np.ndarray: embedding vectors of chunks.</span>
<span class="sd">        pd.DataFrame: Table of topic information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">topic_model</span> <span class="o">=</span> <span class="n">TopicModel</span><span class="p">()</span>
    <span class="n">topics</span> <span class="o">=</span> <span class="n">topic_model</span><span class="o">.</span><span class="n">fit_transform_reduced</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
    <span class="n">embeds</span> <span class="o">=</span> <span class="n">topic_model</span><span class="o">.</span><span class="n">get_doc_embeds</span><span class="p">()</span>
    <span class="n">df_topics</span> <span class="o">=</span> <span class="n">topic_model</span><span class="o">.</span><span class="n">get_topic_table</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">topics</span><span class="p">,</span> <span class="n">embeds</span><span class="p">,</span> <span class="n">df_topics</span></div>



<div class="viewcode-block" id="get_chunk_rank">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.get_chunk_rank">[docs]</a>
<span class="k">def</span> <span class="nf">get_chunk_rank</span><span class="p">(</span><span class="n">arg_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">embeds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In each argument, comput rank of chunks within.</span>

<span class="sd">    Rank can be understood as importance of chunks. This function computes the relative importance of chunks within arguments they belong to. This is done by applying the Pagerank algorithm, where similarity is computed as the cosine similarity of chunk embedding vectors.</span>

<span class="sd">    Args:</span>
<span class="sd">        arg_ids (List[int]): ids of arguments that chunks belongs to.</span>
<span class="sd">        embeds (np.ndarray): embedding vectors of chunks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[float]: rank of chunks</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">rank_in_argument</span><span class="p">(</span><span class="n">embeds</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute pagerank of embedding vectors.&quot;&quot;&quot;</span>
        <span class="n">embeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">embeds</span><span class="p">))</span>
        <span class="n">embeds</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">embeds</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sim_mat</span> <span class="o">=</span> <span class="n">embeds</span> <span class="o">@</span> <span class="n">embeds</span><span class="o">.</span><span class="n">T</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_numpy_array</span><span class="p">(</span><span class="n">sim_mat</span><span class="p">)</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">pagerank</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>

    <span class="n">df_embeds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;arg_id&quot;</span><span class="p">:</span> <span class="n">arg_ids</span><span class="p">,</span> <span class="s2">&quot;embed&quot;</span><span class="p">:</span> <span class="n">embeds</span><span class="o">.</span><span class="n">tolist</span><span class="p">()})</span>
    <span class="n">df_embeds</span> <span class="o">=</span> <span class="n">df_embeds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;arg_id&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;embed&quot;</span><span class="p">:</span> <span class="n">rank_in_argument</span><span class="p">}</span>
    <span class="p">)</span>  <span class="c1"># group by arg_id to make the ranking within arguments</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">df_embeds</span><span class="p">[</span><span class="s2">&quot;embed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">ranks</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ranks</span></div>



<div class="viewcode-block" id="get_chunk_table">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.get_chunk_table">[docs]</a>
<span class="k">def</span> <span class="nf">get_chunk_table</span><span class="p">(</span>
    <span class="n">arg_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">p_scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">topics</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">ranks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given all the measures of chunks, generate and return the chunk table as a pandas dataframe, with pre-defined column names.</span>

<span class="sd">    Args:</span>
<span class="sd">        arg_ids (List[int]): ids of arguments that chunks belong to</span>
<span class="sd">        chunks (List[str]): chunk text</span>
<span class="sd">        p_scores (List[float]): polarity score of chunks</span>
<span class="sd">        topics (List[int]): topic id of chunks</span>
<span class="sd">        ranks (List[float]): rank of chunks</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: chunk table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;argument_id&quot;</span><span class="p">:</span> <span class="n">arg_ids</span><span class="p">,</span>
            <span class="s2">&quot;chunk&quot;</span><span class="p">:</span> <span class="n">chunks</span><span class="p">,</span>
            <span class="s2">&quot;polarity_score&quot;</span><span class="p">:</span> <span class="n">p_scores</span><span class="p">,</span>
            <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="n">topics</span><span class="p">,</span>
            <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">ranks</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="TopicModel">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.TopicModel">[docs]</a>
<span class="k">class</span> <span class="nc">TopicModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Topic modeling class.</span>

<span class="sd">    Functions are implemented based on the BERTopic model. For now, the topic model is setup with a set of default parameters of the sub-models. However, it should be possible that the user can config it further. This will be a next step.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _rd_model (:obj:&#39;UMAP&#39;): instance of UMAP algorithm as the dimensionality reduction sub-model.</span>
<span class="sd">        model (:obj:&#39;BERTopic&#39;): the topic model that applied the sub-models predefined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rd_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialize the topic model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_model</span><span class="p">()</span>

<div class="viewcode-block" id="TopicModel.init_model">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.TopicModel.init_model">[docs]</a>
    <span class="k">def</span> <span class="nf">init_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transformer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;all-mpnet-base-v1&quot;</span><span class="p">,</span>
        <span class="n">n_components</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">min_cluster_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">ngram_min</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">ngram_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the topic model by indicating a number of arguments.</span>

<span class="sd">        Args:</span>
<span class="sd">            transformer (str, optional): Name of the sentence embedding model. Defaults to &quot;all-mpnet-base-v1&quot;. A list of pretrained models can be found here: https://www.sbert.net/docs/pretrained_models.html.</span>
<span class="sd">            n_components (int, optional): Number of dimensions after reduction. Defaults to 5.</span>
<span class="sd">            min_cluster_size (int, optional): Minimum size of clusters for the clustering algorithm. Defaults to 5.</span>
<span class="sd">            ngram_min (int, optional): Low band of ngram range for topic representation. Defaults to 1.</span>
<span class="sd">            ngram_max (int, optional): High band of ngram range for topic representation. Defaults to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span>
        <span class="n">nlp_pipe</span> <span class="o">=</span> <span class="s2">&quot;en_core_web_md&quot;</span>
        <span class="n">load_nlp_pipe</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">nlp_pipe</span><span class="p">)</span>

        <span class="c1"># initialize sub-models</span>
        <span class="n">embed_model</span> <span class="o">=</span> <span class="n">SentenceTransformer</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="o">=</span><span class="n">transformer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rd_model</span> <span class="o">=</span> <span class="n">UMAP</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
        <span class="n">cluster_model</span> <span class="o">=</span> <span class="n">HDBSCAN</span><span class="p">(</span><span class="n">min_cluster_size</span><span class="o">=</span><span class="n">min_cluster_size</span><span class="p">,</span> <span class="n">prediction_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">vector_model</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span>
            <span class="n">stop_words</span><span class="o">=</span><span class="n">language</span><span class="p">,</span> <span class="n">ngram_range</span><span class="o">=</span><span class="p">[</span><span class="n">ngram_min</span><span class="p">,</span> <span class="n">ngram_max</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ctfidf_model</span> <span class="o">=</span> <span class="n">ClassTfidfTransformer</span><span class="p">(</span>
            <span class="n">reduce_frequent_words</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">represent_model</span> <span class="o">=</span> <span class="n">PartOfSpeech</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">nlp_pipe</span><span class="p">,</span>
            <span class="n">pos_patterns</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;POS&quot;</span><span class="p">:</span> <span class="s2">&quot;NOUN&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;POS&quot;</span><span class="p">:</span> <span class="s2">&quot;ADJ&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;POS&quot;</span><span class="p">:</span> <span class="s2">&quot;VERB&quot;</span><span class="p">}]],</span>
        <span class="p">)</span>

        <span class="c1"># initialize topic model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">BERTopic</span><span class="p">(</span>
            <span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span>
            <span class="n">embedding_model</span><span class="o">=</span><span class="n">embed_model</span><span class="p">,</span>
            <span class="n">umap_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rd_model</span><span class="p">,</span>
            <span class="n">hdbscan_model</span><span class="o">=</span><span class="n">cluster_model</span><span class="p">,</span>
            <span class="n">vectorizer_model</span><span class="o">=</span><span class="n">vector_model</span><span class="p">,</span>
            <span class="n">ctfidf_model</span><span class="o">=</span><span class="n">ctfidf_model</span><span class="p">,</span>
            <span class="n">representation_model</span><span class="o">=</span><span class="n">represent_model</span><span class="p">,</span>
            <span class="n">calculate_probabilities</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TopicModel.fit_transform_reduced">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.TopicModel.fit_transform_reduced">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_transform_reduced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Further reduce outliers from the result of the fit_transform function.</span>

<span class="sd">        Note that BERTopic is a clustering approach, which means that it doesn not work if there is nothing to be clustered. And keep in mind that the input corpus should contain at least 1000 documents to get meaningful results. Refer to this thread: https://github.com/MaartenGr/BERTopic/issues/59#issuecomment-775718747.</span>

<span class="sd">        Args:</span>
<span class="sd">            docs (List[str]): The input corpus.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int]: Topics of the input docs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The input corpus should contain at least 1000 documents to get meaningful results. Got </span><span class="si">%d</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">topics</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_topics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">reduce_outliers</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">topics</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;embeddings&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to reduce outliers: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">new_topics</span> <span class="o">=</span> <span class="n">topics</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">update_topics</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">topics</span><span class="o">=</span><span class="n">new_topics</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_topics</span></div>


<div class="viewcode-block" id="TopicModel.get_topic_table">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.TopicModel.get_topic_table">[docs]</a>
    <span class="k">def</span> <span class="nf">get_topic_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the table of topic information and return it as a pandas dataframe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: The topic table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">topic_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_topic_info</span><span class="p">()</span>
        <span class="n">topic_info</span> <span class="o">=</span> <span class="n">topic_info</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;Representative_Docs&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">topic_info</span> <span class="o">=</span> <span class="n">topic_info</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;Topic&quot;</span><span class="p">:</span> <span class="s2">&quot;topic&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Count&quot;</span><span class="p">:</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Representation&quot;</span><span class="p">:</span> <span class="s2">&quot;keywords&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">topic_info</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">topic_info</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">topic_info</span></div>


<div class="viewcode-block" id="TopicModel.get_doc_embeds">
<a class="viewcode-back" href="../autoapi/chunker/index.html#chunker.TopicModel.get_doc_embeds">[docs]</a>
    <span class="k">def</span> <span class="nf">get_doc_embeds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the embeddings of the docs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Embeddings of the docs, in size of (n_doc, n_components).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rd_model</span><span class="o">.</span><span class="n">embedding_</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright The Netherlands eScience Center and the Human Centered Data Analysis Group in Centrum Wiskunde &amp; Informatica, Netherlands..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>